<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Postgres Notes - keshab: software developer from Nepal</title><style>body{color:#333333;font-size:14px;font-family:sans-serif}h1{font-size:18px;margin:0px;color:#000000}h2{font-size:16px}h3{font-size:15px}h4{font-size:14px}h5{font-size:13px}.container{max-width:800px;margin:auto}a:link,a:visited{color:#0822e1;text-decoration:none}a:hover,a:active{color:#06a8e7}.hidden{visibility:hidden}.toc{list-style:none;padding-left:0}.toc li{margin-bottom:10px}.toc .mg{color:#7a7777}.head{border-bottom:solid 1px #efefef}.preamble{font-size:11px;color:#595555;padding-bottom:1px}.footer{border-top:solid 1px #efefef;padding:10px 0}.pd{margin:10px 0 10px 0}.psub{margin-bottom:5px;font-size:13px;color:grey}p code{background-color:#f6f6f6!important}
.codehilite .hll{background-color:#ffffcc}.codehilite{background:#f8f8f8}.codehilite .c{color:#408080;font-style:italic}.codehilite .err{border:1px solid #FF0000}.codehilite .k{color:#008000;font-weight:bold}.codehilite .o{color:#666666}.codehilite .ch{color:#408080;font-style:italic}.codehilite .cm{color:#408080;font-style:italic}.codehilite .cp{color:#BC7A00}.codehilite .cpf{color:#408080;font-style:italic}.codehilite .c1{color:#408080;font-style:italic}.codehilite .cs{color:#408080;font-style:italic}.codehilite .gd{color:#A00000}.codehilite .ge{font-style:italic}.codehilite .gr{color:#FF0000}.codehilite .gh{color:#000080;font-weight:bold}.codehilite .gi{color:#00A000}.codehilite .go{color:#888888}.codehilite .gp{color:#000080;font-weight:bold}.codehilite .gs{font-weight:bold}.codehilite .gu{color:#800080;font-weight:bold}.codehilite .gt{color:#0044DD}.codehilite .kc{color:#008000;font-weight:bold}.codehilite .kd{color:#008000;font-weight:bold}.codehilite .kn{color:#008000;font-weight:bold}.codehilite .kp{color:#008000}.codehilite .kr{color:#008000;font-weight:bold}.codehilite .kt{color:#B00040}.codehilite .m{color:#666666}.codehilite .s{color:#BA2121}.codehilite .na{color:#7D9029}.codehilite .nb{color:#008000}.codehilite .nc{color:#0000FF;font-weight:bold}.codehilite .no{color:#880000}.codehilite .nd{color:#AA22FF}.codehilite .ni{color:#999999;font-weight:bold}.codehilite .ne{color:#D2413A;font-weight:bold}.codehilite .nf{color:#0000FF}.codehilite .nl{color:#A0A000}.codehilite .nn{color:#0000FF;font-weight:bold}.codehilite .nt{color:#008000;font-weight:bold}.codehilite .nv{color:#19177C}.codehilite .ow{color:#AA22FF;font-weight:bold}.codehilite .w{color:#bbbbbb}.codehilite .mb{color:#666666}.codehilite .mf{color:#666666}.codehilite .mh{color:#666666}.codehilite .mi{color:#666666}.codehilite .mo{color:#666666}.codehilite .sa{color:#BA2121}.codehilite .sb{color:#BA2121}.codehilite .sc{color:#BA2121}.codehilite .dl{color:#BA2121}.codehilite .sd{color:#BA2121;font-style:italic}.codehilite .s2{color:#BA2121}.codehilite .se{color:#BB6622;font-weight:bold}.codehilite .sh{color:#BA2121}.codehilite .si{color:#BB6688;font-weight:bold}.codehilite .sx{color:#008000}.codehilite .sr{color:#BB6688}.codehilite .s1{color:#BA2121}.codehilite .ss{color:#19177C}.codehilite .bp{color:#008000}.codehilite .fm{color:#0000FF}.codehilite .vc{color:#19177C}.codehilite .vg{color:#19177C}.codehilite .vi{color:#19177C}.codehilite .vm{color:#19177C}.codehilite .il{color:#666666}</style></head> <body> <div class=container> <div class=head> <h1>Postgres Notes</h1> <div class=preamble> List of postgres commands that I always end up having to look up <a href=/ >[Table of Contents]</a> </div> </div> <div class=content> <div class=pd> <div class=psub>2018-05-24 / Kathmandu, Nepal</div> <p>Since I primarily <a href=/p/about-keshab-paudel/ target=_blank>use Django</a>, I don't have the need to write SQL or even use the database shell very often. But once in a while there comes a time when I have to resort to using the dear old <code>pgshell</code>.</p> <h2>Administration</h2> <h3>Starting pgshell</h3> <div class=codehilite><pre><span></span><code><span class=c1># switch to `postgres` user</span>
sudo su postgres

<span class=c1># just run</span>
psql

<span class=c1># OR: with Django project&#39;s manage.py for database specific task</span>
./manage.py dbshell
</code></pre></div> <h3>Insert from a file</h3> <p>Limitation: It should be one query per line for this to work properly.</p> <div class=codehilite><pre><span></span><code><span class=k>def</span> <span class=nf>load_file_queries</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>file_path</span><span class=p>):</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>schema_file</span><span class=p>:</span>
        <span class=n>schemas</span> <span class=o>=</span> <span class=n>schema_file</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span>

    <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>schema</span><span class=p>)</span>
        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</code></pre></div> <h3>Info about the tables</h3> <h4>Columns and their data types.</h4> <p>If the schema is anything other than the default one, append <code>AND table_schema = '&lt;schema_name&gt;'</code> at the end of the query.</p> <div class=codehilite><pre><span></span><code><span class=k>SELECT</span> <span class=k>column_name</span><span class=p>,</span> <span class=n>data_type</span> <span class=k>FROM</span> <span class=n>INFORMATION_SCHEMA</span><span class=p>.</span><span class=n>COLUMNS</span>
<span class=k>WHERE</span> <span class=k>table_name</span> <span class=o>=</span> <span class=s1>&#39;&lt;table_name&gt;&#39;</span><span class=p>;</span>
</code></pre></div> <p>The result will be something like this:</p> <pre><code> id                   | integer
 password             | character varying
 last_login           | timestamp with time zone
</code></pre> <h4>Find the primary key</h4> <p>To know the primary key of a table:</p> <div class=codehilite><pre><span></span><code><span class=k>SELECT</span> <span class=n>a</span><span class=p>.</span><span class=n>attname</span><span class=p>,</span> <span class=n>format_type</span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>atttypid</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>atttypmod</span><span class=p>)</span> <span class=k>AS</span> <span class=n>data_type</span>
<span class=k>FROM</span>   <span class=n>pg_index</span> <span class=n>i</span>
<span class=k>JOIN</span>   <span class=n>pg_attribute</span> <span class=n>a</span> <span class=k>ON</span> <span class=n>a</span><span class=p>.</span><span class=n>attrelid</span> <span class=o>=</span> <span class=n>i</span><span class=p>.</span><span class=n>indrelid</span>
                     <span class=k>AND</span> <span class=n>a</span><span class=p>.</span><span class=n>attnum</span> <span class=o>=</span> <span class=k>ANY</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>indkey</span><span class=p>)</span>
<span class=k>WHERE</span>  <span class=n>i</span><span class=p>.</span><span class=n>indrelid</span> <span class=o>=</span> <span class=s1>&#39;&lt;tablename&gt;&#39;</span><span class=p>::</span><span class=n>regclass</span>
<span class=k>AND</span>    <span class=n>i</span><span class=p>.</span><span class=n>indisprimary</span><span class=p>;</span>
</code></pre></div> <h2>In Docker</h2> <p>If there's a need to run a version of postgresql that is not in the system packages repository then Docker is probably the best option.</p> <h3>In docker-compose.yml</h3> <pre><code>  db:
    image: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - ./path/to/initial.sql:/docker-entrypoint-initdb.d/initial.sql
    expose:
      - 5432
</code></pre> <h3>Pull and run the image</h3> <p>Pull the required image, see docker hub page for <a href=https://hub.docker.com/_/postgres/ target=_blank>postgres</a> and find the version you desire.</p> <div class=codehilite><pre><span></span><code>docker run --name &lt;FANCY_NAME&gt; -e <span class=nv>POSTGRES_USER</span><span class=o>=</span>&lt;USER&gt; -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>&lt;PASSWORD&gt; -d -p <span class=m>5433</span>:5432 postgres:9.6.9
</code></pre></div> <ul> <li><code>--name &lt;FANCY_NAME&gt;</code>: Something unique, short and descriptive to refer to the instance of the created container.</li> <li><code>-e POSTGRES_USER=&lt;USER&gt;</code>: If provided, the user will be created.</li> <li><code>-e POSTGRES_PASSWORD=&lt;PASSWORD&gt;</code>: Password for the user.</li> <li><code>-d</code>: Detach the container, i.e. run in the background</li> <li><code>-p 5433:5432</code>: Postgres runs on <code>5432</code> by default, we are mapping <code>5433</code> on host to the <code>5432</code> on the container because <code>5432</code> might be already in use on the host system.</li> <li><code>postgres:9.6.9</code>: Name of the image.</li> </ul> <h3>Restore from other instances</h3> <p>Create a dump by running this command:</p> <div class=codehilite><pre><span></span><code>pg_dumpall -h localhost -p <span class=m>5432</span> -U postgres -c &gt;  <span class=s2>&quot;/home/something/backup.sql&quot;</span>
</code></pre></div> <p>To restore, run the following command:</p> <div class=codehilite><pre><span></span><code>cat /home/something/backup.sql <span class=p>|</span> docker <span class=nb>exec</span> -i &lt;FANCY_NAME&gt; psql -Upostgres
</code></pre></div> <ul> <li><code>&lt;FANCY_NAME&gt;</code>: This is the name of the container.</li> </ul> <h2>Read</h2> <ul> <li><a href=http://durandom.de/docker/postgres/2016/12/20/pg_dump/ target=_blank>pg_dump and restore a db in a container</a></li> <li><a target=_blank href=https://gist.github.com/gilyes/525cc0f471aafae18c3857c27519fc4b>Backup, restore postgres in docker container</a></li> <li><a href=https://ryaneschinger.com/blog/dockerized-postgresql-development-environment/ target=_blank>Dockerized Postgresql Development Environment</a></li> <li><a href=https://www.mkyong.com/database/backup-restore-database-in-postgresql-pg_dumppg_restore/ target=_blank>Backup &amp; Restore Database in PostgreSQL (pg_dump,pg_restore)</a></li> <li><a href=https://pgolub.wordpress.com/2013/11/19/dump-and-restore-of-postgresql-version-compatibility-faq/ target=_blank>Dump and restore of PostgreSQL: version compatibility FAQ</a></li> <li><a target=_blank href=https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546>Gist: PostgreSQL command line cheatsheet</a></li> <li><a href=https://blog.jasonmeridth.com/posts/postgresql-command-line-cheat-sheet/ target=_blank>Jason Meridth: PostgreSQL Command Line Cheat Sheet</a></li> <li><a target=_blank href=https://wiki.postgresql.org/wiki/Retrieve_primary_key_columns>Retrieve primary key columns</a></li> </ul> </div> </div> <div class=footer> <a href=/ >Home</a> | <a target=_blank href=https://github.com/poudel>Github</a> | <a href=https://www.linkedin.com/in/keshabpaudel/ target=_blank>Linkedin</a> | <a href=/sitemaps.xml>Sitemaps</a> | Since 2017 </div> </div> </body> </html>